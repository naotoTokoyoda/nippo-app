# テストデータ管理スクリプト

このディレクトリには、日報アプリのパフォーマンステスト用のスクリプトが含まれています。

## 📁 ファイル構成

- `generate-test-data.ts` - 大量のテストデータを生成
- `clear-test-data.ts` - テストデータを削除
- `performance-test.ts` - パフォーマンステストを実行

## 🚀 使用方法

### 1. テストデータの生成

```bash
npm run generate-test-data
```

**生成されるデータ量:**
- 作業者: 10人
- 客先: 50社
- 機械: 20種類
- 工番: 200件
- 日報: 1,000件
- 作業項目: 約5,000件（1日報あたり1-5個）

### 2. テストデータの削除

```bash
npm run clear-test-data
```

### 3. パフォーマンステストの実行

```bash
npm run performance-test
```

**テスト内容:**
- 最適化前後のクエリ実行時間を比較
- 複数のフィルター条件でテスト
- 各条件で10回ずつ実行して平均値を算出

## ⚙️ 設定の変更

### データ量の調整

`generate-test-data.ts`の`CONFIG`オブジェクトを編集：

```typescript
const CONFIG = {
  users: 10,           // 作業者数
  customers: 50,       // 客先数
  machines: 20,        // 機械種類数
  workOrders: 200,     // 工番数
  reports: 1000,       // 日報数
  reportItemsPerReport: 5, // 1日報あたりの作業項目数
};
```

### パフォーマンステストの調整

`performance-test.ts`の`TEST_CONFIG`オブジェクトを編集：

```typescript
const TEST_CONFIG = {
  iterations: 10,      // 各条件のテスト回数
  filters: [           // テストするフィルター条件
    { month: '2024-01' },
    { month: '2024-01', workerName: '田中太郎' },
    // 他の条件...
  ]
};
```

## 📊 期待される結果

### パフォーマンス改善

最適化により以下の改善が期待されます：

- **クエリ実行時間**: 50-80%の短縮
- **メモリ使用量**: 大幅な削減
- **初期読み込み時間**: 1秒以上の短縮

### テストデータの特徴

- **リアルなデータ**: 日本語の会社名、作業者名、機械名
- **多様な条件**: 様々な日付、作業者、客先の組み合わせ
- **実際の使用パターン**: 本番環境に近いデータ分布

## 🔧 トラブルシューティング

### データベース接続エラー

```bash
# データベースの状態を確認
npm run db:studio
```

### メモリ不足エラー

大量のデータを生成する際にメモリ不足が発生した場合：

1. データ量を減らす（`CONFIG`の値を小さくする）
2. バッチサイズを小さくする（`generate-test-data.ts`の`batchSize`を変更）

### 外部キー制約エラー

データの削除時にエラーが発生した場合：

```bash
# データベースをリセット
npm run db:push
```

## 📈 パフォーマンステストの解釈

### 改善率の計算

```
改善率 = (古いクエリ時間 - 新しいクエリ時間) / 古いクエリ時間 × 100
```

### 期待される改善率

- **単純なフィルター**: 30-50%
- **複雑なフィルター**: 50-80%
- **大量データ**: 60-90%

## 🎯 ベストプラクティス

1. **テスト前にデータをクリア**: 正確な結果のため
2. **複数回実行**: キャッシュの影響を排除
3. **段階的なテスト**: 小さいデータ量から開始
4. **本番環境での検証**: 実際の使用環境でのテスト

## 📝 注意事項

- テストデータは本番環境では使用しないでください
- 大量のデータ生成には時間がかかります（5-10分程度）
- データベースの容量を確認してから実行してください
- バックアップを取ってからテストを実行することを推奨します
