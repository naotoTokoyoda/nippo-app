# 本番環境マイグレーション手順

## 概要
`workDescription`フィールドを追加し、既存データを保持しながら本番環境をアップデートします。

## ⚠️ 注意事項
- **本番データを保持**したままマイグレーションを実行します
- **バックアップ推奨**: 念のため事前にデータベースのバックアップを取ることを推奨します
- **ダウンタイム**: マイグレーション中は短時間のダウンタイムが発生する可能性があります

## 🔧 実行手順

### Step 1: 本番環境にデプロイ
```bash
# mainブランチが最新であることを確認
git checkout main
git pull origin main

# 本番環境にデプロイ（Vercelの場合は自動デプロイ）
```

### Step 2: データベースマイグレーション実行
```bash
# 本番環境の環境変数を設定
# DATABASE_URLが本番データベースを指していることを確認

# マイグレーションを実行（既存データは保持される）
npx prisma migrate deploy

# Prismaクライアントを再生成
npx prisma generate
```

### Step 3: 既存データの移行
```bash
# 既存のworkOrder.descriptionをworkDescriptionにコピー
npx tsx scripts/migrate-work-descriptions.ts
```

### Step 4: 動作確認
1. アプリケーションにアクセス
2. 日報一覧で既存データが正しく表示されることを確認
3. 新規日報作成テスト
4. 編集機能のテスト

## 📊 期待される結果

### マイグレーション前
- 同じ工番 → 同じ作業名称（最初の登録内容で固定）

### マイグレーション後  
- 同じ工番 → 各作業項目ごとに独立した作業名称
- 既存データ → workDescriptionに移行済み
- 新規データ → workDescriptionに直接保存

## 🔄 ロールバック手順（必要時）

万が一問題が発生した場合：

```bash
# 1. 前のバージョンにロールバック
git checkout <前のコミットハッシュ>

# 2. データベースも必要に応じてロールバック
# （Neonの場合はバックアップから復元）
```

## ✅ 確認ポイント

- [ ] 既存の日報データが正しく表示される
- [ ] 同じ工番で異なる作業内容が正しく区別される
- [ ] 新規日報作成が正常に動作する
- [ ] 編集機能が正常に動作する
- [ ] 背景色による条件付きフォーマットが正常に動作する
- [ ] 時間計算が正常に動作する

## 📞 トラブルシューティング

### よくある問題と解決策

1. **マイグレーションが失敗する**
   - DATABASE_URLが正しく設定されているか確認
   - ネットワーク接続を確認

2. **既存データが表示されない**
   - データ移行スクリプトが正常に実行されたか確認
   - ブラウザのキャッシュをクリア

3. **新規データが保存されない**
   - Prismaクライアントが再生成されているか確認
   - アプリケーションを再起動

## 📝 実行ログ例

```
🚀 データ移行を開始します...
📊 移行対象のレポートアイテム: 1,234件
📝 進行状況: 100/1,234件完了
📝 進行状況: 200/1,234件完了
...
✅ データ移行が完了しました！
📊 移行統計:
   - 移行完了: 1,234件
   - スキップ: 0件
   - 合計処理: 1,234件
🎉 スクリプトが正常に完了しました。
```
