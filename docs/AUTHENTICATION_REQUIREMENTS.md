# 認証システム要件定義書

## 1. 概要

日報アプリにNextAuth.js認証システムを導入し、全ページへのアクセスを認証必須とする。

### 1.1 目的

- ユーザーの識別と認証
- 役割に基づくアクセス制御
- 機密情報（会社名、品物名、工数・金額）の保護
- 操作履歴の追跡（監査ログ）

### 1.2 技術スタック

| 項目 | 技術 |
|------|------|
| 認証ライブラリ | NextAuth.js (Auth.js) |
| パスワードハッシュ | bcryptjs |
| セッション管理 | JWT（Cookie） |
| PIN保存 | sessionStorage（タブ単位） |

---

## 2. ユーザー構成

| ロール | ユーザー | 用途 |
|--------|----------|------|
| **admin** | 常世田直人 | 管理者個人アカウント |
| **manager** | 新工場 | 新工場共有端末用（NextAuthログインのみ） |
| **manager** | 旧工場 | 旧工場共有端末用（NextAuthログインのみ） |
| **member** | 作業者たち | PIN認証で本人確認して日報入力 |

---

## 3. 認証方式

### 3.1 NextAuth認証（admin / manager）

| 項目 | 内容 |
|------|------|
| 認証情報 | Email + Password |
| セッション有効期限 | **24時間** |
| 用途 | アプリ全体へのアクセス |

### 3.2 PIN認証（member）

| 項目 | 内容 |
|------|------|
| 認証情報 | 作業者名 + 4桁PIN |
| 用途 | 日報入力時の本人確認 |

#### PIN認証のタイミング

| ページ | PIN認証 | 終了タイミング |
|--------|---------|----------------|
| 日報入力 | 必須 | 送信完了時 |
| 日報一覧 | 必須 | 無操作10分 |

### 3.3 認証の組み合わせ

```
工場端末での日報入力：
┌─────────────────────────────────────────────────────────────┐
│ ① 工場アカウント（manager）でNextAuthログイン               │
│    └─ 端末がアプリにアクセス可能になる                      │
│                                                             │
│ ② 作業者（member）がPIN認証で本人確認                       │
│    └─ 「誰が」日報を入力したか特定                          │
│                                                             │
│ ※ 工場アカウント自体はPIN認証しない                         │
│ ※ PIN認証するのは作業者（member）のみ                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 4. 認証フロー

### 4.1 工場端末（日報入力）

```
工場端末（新工場/旧工場）
    ↓
① 朝、工場アカウントでNextAuthログイン
   （新工場端末 → shinkojo@nippo.local）
   （旧工場端末 → kyukojo@nippo.local）
    ↓
② ログイン後、端末は「manager」として認証済み
    ↓
③ 作業者（member）がPIN認証で本人確認
    ↓
④ 日報入力 → 送信完了 → PIN認証解除
    ↓
⑤ 次の作業者がPIN認証...（繰り返し）
    ↓
⑥ 24時間後、NextAuthセッション期限切れ → 翌朝再ログイン
```

### 4.2 管理者（常世田直人）

```
任意の端末
    ↓
① 個人アカウントでNextAuthログイン
   （admin@nippo.local）
    ↓
② 集計機能・管理画面にアクセス
    ↓
③ 24時間後、セッション期限切れ → 再ログイン
```

---

## 5. ページ別アクセス権限

| ページ | 未ログイン | admin | manager（工場） | member（PIN後） |
|--------|:----------:|:-----:|:---------------:|:---------------:|
| ログインページ | ✅ | - | - | - |
| ホーム | ❌ | ✅ | ✅ | - |
| 日報入力 | ❌ | ❌ | ✅(PIN必要) | ✅ |
| 日報一覧 | ❌ | ❌ | ✅(PIN必要) | ✅ |
| 集計機能 | ❌ | ✅ | ✅ | ❌ |
| 管理画面 | ❌ | ✅ | ✅(一部制限) | ❌ |

**注**: 日報入力・日報一覧は、managerでログイン後、memberがPIN認証して使用する。

---

## 6. 機能別アクセス権限

### 6.1 日報関連

| 機能 | admin | manager | member（PIN後） |
|------|:-----:|:-------:|:---------------:|
| 日報入力 | ❌ | - | ✅ |
| 自分の日報編集 | ❌ | - | ✅ |
| 他人の日報編集 | ❌ | - | ❌ |

### 6.2 集計関連

| 機能 | admin | manager |
|------|:-----:|:-------:|
| 集計閲覧 | ✅ | ✅ |
| コメント追加 | ✅ | ✅ |
| 最終金額確定 | ✅ | ✅ |
| 材料費編集 | ✅ | ✅ |

### 6.3 管理画面

| 機能 | admin | manager |
|------|:-----:|:-------:|
| 単価設定 | ✅ | ✅ |
| 機械マスタ | ✅ | ✅ |
| admin管理 | ✅ | ❌ |
| manager管理 | ✅ | ❌ |
| member管理 | ✅ | ✅ |
| 監査ログ | ✅ | ✅ |

---

## 7. ユーザーデータ

### 7.1 admin（管理者）

| 名前 | Email | Password | PIN |
|------|-------|:--------:|:---:|
| 常世田直人 | admin@nippo.local | ✅ | ❌ |

### 7.2 manager（工場アカウント）

| 名前 | Email | Password | PIN | 備考 |
|------|-------|:--------:|:---:|------|
| 新工場 | shinkojo@nippo.local | ✅ | ❌ | 新工場共有端末用 |
| 旧工場 | kyukojo@nippo.local | ✅ | ❌ | 旧工場共有端末用 |

### 7.3 member（作業者）

| 名前 | Email | Password | PIN | 備考 |
|------|:-----:|:--------:|:---:|------|
| 常世田博 | ❌ | ❌ | ✅ | |
| 野城喜幸 | ❌ | ❌ | ✅ | |
| 三好耕平 | ❌ | ❌ | ✅ | |
| 高梨純一 | ❌ | ❌ | ✅ | |
| （トン）シーワイ チャナラット | ❌ | ❌ | ✅ | 実習生 |
| （ポーン）テートシームアン タナーポーン | ❌ | ❌ | ✅ | 実習生 |
| （コー）ジャンペンペーン パッタウィ | ❌ | ❌ | ✅ | 実習生 |

---

## 8. セッション設定

| 項目 | 値 |
|------|-----|
| セッション有効期限 | **24時間** |
| セッション方式 | JWT（Cookie） |

### 8.1 有効期限の理由

- 機密情報（会社名、品物名、工数・金額）を保護
- 毎朝のログインを習慣化
- 端末紛失時のリスク軽減

---

## 9. 監査ログ

### 9.1 記録する操作

| カテゴリ | 操作 |
|----------|------|
| 認証 | ログイン成功/失敗、ログアウト、PIN認証成功/失敗 |
| 日報 | 作成、編集、削除 |
| 集計 | コメント追加/編集/削除、最終金額確定 |
| 管理 | ユーザー追加/編集/削除、単価変更、機械追加/編集 |

### 9.2 閲覧権限

| ロール | 閲覧 |
|--------|:----:|
| admin | ✅ |
| manager | ✅ |
| member | ❌ |

---

## 10. 運用ルール

### 10.1 毎朝の作業

1. 新工場端末：`shinkojo@nippo.local` でログイン
2. 旧工場端末：`kyukojo@nippo.local` でログイン

### 10.2 パスワード管理

- 工場アカウントのパスワードはマネージャーが管理
- 万が一ログアウトした場合はマネージャーが再ログイン

### 10.3 作業者の日報入力

1. ログイン済み端末でPINを入力して本人確認
2. 日報を入力・送信
3. 送信完了後、自動でPIN認証解除（次の人が使える状態）

---

## 11. セキュリティ考慮事項

### 11.1 パスワード

- bcryptjs でハッシュ化して保存
- 平文パスワードはDBに保存しない

### 11.2 セッション

- HTTPOnly Cookie でセッション管理
- 24時間で自動期限切れ

### 11.3 PIN

- 4桁の数字（0000〜9999）
- sessionStorage に保存（タブを閉じると消える）
- 日報送信完了で自動クリア

### 11.4 全ページ認証必須

- 未ログイン状態ではどのページにもアクセス不可
- ログインページのみアクセス可能
- Basic認証は使用しない（削除）

---

## 12. 実装タスク

| # | タスク | 状態 |
|---|--------|------|
| 1 | NextAuth.js セットアップ | ✅ 完了 |
| 2 | PIN認証コンポーネント | ✅ 完了 |
| 3 | ページのアクセス制御（middleware） | ⏳ 更新必要 |
| 4 | 全ページにNextAuth認証を必須化 | ⏳ 未着手 |
| 5 | AuthGuard（Basic認証）を削除 | ⏳ 未着手 |
| 6 | ユーザーデータ更新（工場アカウント追加） | ⏳ 未着手 |
| 7 | ユーザー管理画面の権限制御 | ✅ 完了 |
| 8 | 監査ログ | ⏳ 未着手 |
| 9 | テスト | ⏳ 未着手 |

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2024-12-09 | 初版作成 |
| 2024-12-09 | 工場アカウント方式に変更、全ページ認証必須化 |

